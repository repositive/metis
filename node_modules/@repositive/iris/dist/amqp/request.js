"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const uuid_1 = require("uuid");
class TimeoutError extends Error {
    constructor(msg) {
        super(msg || 'Timeout');
    }
}
exports.TimeoutError = TimeoutError;
class RPCError extends Error {
    constructor(msg) {
        super(msg || 'Remote rejection');
    }
}
exports.RPCError = RPCError;
function setupRequest({ ch, exchange, _setTimeout = setTimeout, _clearTimeout = clearTimeout, _log = console }) {
    return __awaiter(this, void 0, void 0, function* () {
        return function request({ pattern, payload, timeout = 100 }) {
            return __awaiter(this, void 0, void 0, function* () {
                const q = yield ch.assertQueue('', { exclusive: true });
                const correlation = uuid_1.v4();
                const content = payload ? payload : Buffer.alloc(0);
                ch.publish(exchange, pattern, content, {
                    correlationId: correlation,
                    replyTo: q.queue
                });
                return new Promise((resolve, reject) => {
                    const time = _setTimeout(() => {
                        ch.deleteQueue(q.queue)
                            .then(() => {
                            reject(new TimeoutError('Timeout'));
                        })
                            .catch(reject);
                    }, timeout);
                    ch.consume(q.queue, (msg) => {
                        if (msg && msg.properties.correlationId === correlation) {
                            try {
                                _clearTimeout(time);
                                ch.deleteQueue(q.queue);
                                if (msg.properties.headers.code === 0) {
                                    resolve(msg.content);
                                }
                                else {
                                    reject(new RPCError(msg.content.toString()));
                                }
                            }
                            catch (err) {
                                reject(err);
                            }
                            ch.ack(msg);
                        }
                        //TODO: If the correlationId does not mach... We should never get here. If that's the case maybe move the msg to error queue?
                    });
                });
            });
        };
    });
}
exports.setupRequest = setupRequest;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hbXFwL3JlcXVlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUVBLCtCQUF3QjtBQVF4QixrQkFBMEIsU0FBUSxLQUFLO0lBQ3JDLFlBQVksR0FBWTtRQUN0QixLQUFLLENBQUMsR0FBRyxJQUFJLFNBQVMsQ0FBQyxDQUFDO0lBQzFCLENBQUM7Q0FDRjtBQUpELG9DQUlDO0FBRUQsY0FBc0IsU0FBUSxLQUFLO0lBQ2pDLFlBQVksR0FBWTtRQUN0QixLQUFLLENBQUMsR0FBRyxJQUFJLGtCQUFrQixDQUFDLENBQUM7SUFDbkMsQ0FBQztDQUNGO0FBSkQsNEJBSUM7QUFVRCxzQkFBc0MsRUFDcEMsRUFBRSxFQUNGLFFBQVEsRUFDUixXQUFXLEdBQUcsVUFBVSxFQUN4QixhQUFhLEdBQUcsWUFBWSxFQUM1QixJQUFJLEdBQUcsT0FBTyxFQUNHOztRQUVqQixNQUFNLENBQUMsaUJBQXVCLEVBQzVCLE9BQU8sRUFDUCxPQUFPLEVBQ1AsT0FBTyxHQUFHLEdBQUcsRUFDRDs7Z0JBQ1osTUFBTSxDQUFDLEdBQUcsTUFBTSxFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsRUFBRSxFQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDO2dCQUN0RCxNQUFNLFdBQVcsR0FBSSxTQUFFLEVBQUUsQ0FBQztnQkFDMUIsTUFBTSxPQUFPLEdBQUcsT0FBTyxHQUFHLE9BQU8sR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNwRCxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFO29CQUNyQyxhQUFhLEVBQUUsV0FBVztvQkFDMUIsT0FBTyxFQUFFLENBQUMsQ0FBQyxLQUFLO2lCQUNqQixDQUFDLENBQUM7Z0JBRUgsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFTLENBQUMsT0FBTyxFQUFFLE1BQU07b0JBRXpDLE1BQU0sSUFBSSxHQUFHLFdBQVcsQ0FDdEI7d0JBQ0UsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDOzZCQUNwQixJQUFJLENBQUM7NEJBQ0osTUFBTSxDQUFDLElBQUksWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7d0JBQ3RDLENBQUMsQ0FBQzs2QkFDRCxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQ25CLENBQUMsRUFDRCxPQUFPLENBQ1IsQ0FBQztvQkFFRixFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxHQUFhO3dCQUNoQyxFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLFVBQVUsQ0FBQyxhQUFhLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQzs0QkFDeEQsSUFBSSxDQUFDO2dDQUNILGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQ0FDcEIsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7Z0NBQ3hCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO29DQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dDQUN2QixDQUFDO2dDQUFDLElBQUksQ0FBQyxDQUFDO29DQUNOLE1BQU0sQ0FBQyxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztnQ0FDL0MsQ0FBQzs0QkFDSCxDQUFDOzRCQUFDLEtBQUssQ0FBQSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0NBQ1osTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDOzRCQUNkLENBQUM7NEJBQ0QsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQzt3QkFDZCxDQUFDO3dCQUVELDZIQUE2SDtvQkFDL0gsQ0FBQyxDQUFDLENBQUM7Z0JBQ0wsQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDO1NBQUEsQ0FBQztJQUNKLENBQUM7Q0FBQTtBQXRERCxvQ0FzREMifQ==